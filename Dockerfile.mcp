# Use official Node.js slim image as the base
FROM node:slim

# Set working directory
WORKDIR /app

# Copy configuration files
COPY package*.json nx.json tsconfig*.json ./
COPY mcp/package.json ./mcp/
COPY mcp/project.json ./mcp/
COPY mcp/tsconfig.json ./mcp/

# Install all dependencies including Nx
RUN npm install

# Ensure Nx plugins are properly installed (fix for @nx/node/plugin not found)
RUN npm install --save-dev @nrwl/node @nrwl/workspace nx @nx/node @nx/workspace
RUN npm install -g nx

# Copy source code
COPY mcp/src ./mcp/src
COPY mcp/scripts ./mcp/scripts
COPY lib ./lib
COPY services ./services
COPY shared ./shared
COPY app/types ./app/types

# Ensure the post-build script is executable
RUN chmod +x mcp/scripts/post-build.sh

# Build the application using Nx
RUN npx nx reset
RUN npx nx build mcp || (echo "Nx build failed, checking errors" && ls -la && cat mcp/project.json && exit 1)

# Remove dev dependencies for a smaller image
RUN npm prune --production

# Expose the application port
EXPOSE 8080

# Set environment variables
ENV PORT=8080
ENV NODE_PATH=/app

# Start the application
CMD ["node", "dist/mcp/main.js"]
